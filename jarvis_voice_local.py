"""
JARVIS LOCAL VOICE ENGINE
Direct voice interaction without LiveKit dependency
Perfect for local Iron Man experience
"""

import asyncio
import os
import sys
import time
from datetime import datetime
import threading
import queue

# Add project path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Core imports that should always work
try:
    import speech_recognition as sr
    import pyttsx3
    import numpy as np
    HAS_VOICE = True
except ImportError as e:
    print(f"‚ùå Voice dependencies missing: {e}")
    HAS_VOICE = False

# Load environment
try:
    from dotenv import load_dotenv
    load_dotenv()
except:
    pass

from assistant.ai_engine import JarvisAI

class JarvisLocalVoiceEngine:
    """Local JARVIS Voice Engine - Works without internet dependencies"""
    
    def __init__(self):
        print("üî• Initializing JARVIS Local Voice Engine...")
        
        # Initialize AI engine
        self.ai = JarvisAI()
        
        # Voice components
        self.recognizer = sr.Recognizer()
        self.microphone = None
        self.tts_engine = None
        
        # Voice state
        self.is_listening = False
        self.is_speaking = False
        self.conversation_active = False
        self.wake_words = ["jarvis", "hey jarvis", "okay jarvis", "computer"]
        
        # Conversation context
        self.conversation_buffer = []
        self.last_interaction = None
        
        # Initialize components
        self.setup_microphone()
        self.setup_tts()
        
        print("‚úÖ JARVIS Local Voice Engine initialized")
        
    def setup_microphone(self):
        """Setup microphone for speech recognition"""
        try:
            # List available microphones
            mic_list = sr.Microphone.list_microphone_names()
            print(f"üé§ Found {len(mic_list)} microphones")
            
            if mic_list:
                print(f"üéôÔ∏è Using: {mic_list[0]}")
                self.microphone = sr.Microphone()
                
                # Calibrate for ambient noise
                with self.microphone as source:
                    print("üîß Calibrating microphone...")
                    self.recognizer.adjust_for_ambient_noise(source, duration=1)
                    print(f"‚úÖ Energy threshold: {self.recognizer.energy_threshold}")
                    
                return True
            else:
                print("‚ùå No microphones found")
                return False
                
        except Exception as e:
            print(f"‚ùå Microphone setup error: {e}")
            return False
    
    def setup_tts(self):
        """Setup text-to-speech engine"""
        try:
            self.tts_engine = pyttsx3.init()
            
            # Get available voices
            voices = self.tts_engine.getProperty('voices')
            print(f"üó£Ô∏è Found {len(voices)} TTS voices")
            
            # Configure voice settings
            if voices:
                # Prefer male voice for JARVIS
                male_voice = None
                for voice in voices:
                    if 'male' in voice.name.lower() or 'david' in voice.name.lower():
                        male_voice = voice
                        break
                
                if male_voice:
                    self.tts_engine.setProperty('voice', male_voice.id)
                    print(f"üéµ Using voice: {male_voice.name}")
                else:
                    self.tts_engine.setProperty('voice', voices[0].id)
                    print(f"üéµ Using voice: {voices[0].name}")
            
            # Set speech parameters
            self.tts_engine.setProperty('rate', 180)  # Speed
            self.tts_engine.setProperty('volume', 0.9)  # Volume
            
            return True
            
        except Exception as e:
            print(f"‚ùå TTS setup error: {e}")
            return False
    
    def speak(self, text, interrupt_check=True):
        """Speak text using TTS"""
        try:
            if not self.tts_engine or not text:
                return
                
            print(f"üó£Ô∏è JARVIS: {text}")
            
            self.is_speaking = True
            self.tts_engine.say(text)
            self.tts_engine.runAndWait()
            self.is_speaking = False
            
        except Exception as e:
            print(f"‚ùå Speech error: {e}")
            self.is_speaking = False
    
    def listen_for_wake_word(self, timeout=10):
        """Listen for wake word like 'Hey JARVIS'"""
        try:
            if not self.microphone:
                print("‚ùå No microphone available")
                return False
                
            print("üëÇ Listening for wake word... Say 'Hey JARVIS'")
            
            with self.microphone as source:
                # Listen for audio
                try:
                    audio = self.recognizer.listen(source, timeout=timeout, phrase_time_limit=5)
                    
                    # Try to recognize speech
                    try:
                        text = self.recognizer.recognize_google(audio, language='en-US').lower()
                        print(f"üé§ Heard: '{text}'")
                        
                        # Check for wake words
                        for wake_word in self.wake_words:
                            if wake_word in text:
                                print(f"üî• Wake word '{wake_word}' detected!")
                                return True
                                
                        return False
                        
                    except sr.UnknownValueError:
                        print("‚ùì Could not understand audio")
                        return False
                    except sr.RequestError as e:
                        print(f"üîå Recognition service error: {e}")
                        return False
                        
                except sr.WaitTimeoutError:
                    print("‚è∞ Wake word timeout")
                    return False
                    
        except Exception as e:
            print(f"‚ùå Wake word error: {e}")
            return False
    
    def listen_for_command(self, timeout=10):
        """Listen for a command after wake word"""
        try:
            if not self.microphone:
                print("‚ùå No microphone available")
                return None
                
            print("üé§ Listening for command...")
            
            with self.microphone as source:
                try:
                    audio = self.recognizer.listen(source, timeout=timeout, phrase_time_limit=15)
                    
                    # Try to recognize command
                    try:
                        text = self.recognizer.recognize_google(audio, language='en-US')
                        print(f"üìù Command: '{text}'")
                        return text
                        
                    except sr.UnknownValueError:
                        print("‚ùì Could not understand command")
                        return None
                    except sr.RequestError as e:
                        print(f"üîå Recognition service error: {e}")
                        return None
                        
                except sr.WaitTimeoutError:
                    print("‚è∞ Command timeout")
                    return None
                    
        except Exception as e:
            print(f"‚ùå Command listening error: {e}")
            return None
    
    def process_command(self, command):
        """Process voice command with AI"""
        try:
            # Handle special commands
            if command.lower() in ["stop", "exit", "goodbye", "shut down"]:
                self.speak("Goodbye, Sir. JARVIS signing off.")
                return False
                
            if command.lower() in ["stop listening", "voice off"]:
                self.speak("Voice interface deactivated.")
                return False
            
            # Process with AI
            print(f"üß† Processing with AI...")
            response = self.ai.chat(command)
            
            # Store in conversation buffer
            self.conversation_buffer.append(f"User: {command}")
            self.conversation_buffer.append(f"JARVIS: {response}")
            
            # Keep buffer reasonable size
            while len(self.conversation_buffer) > 10:
                self.conversation_buffer.pop(0)
            
            # Speak response
            self.speak(response)
            
            return True
            
        except Exception as e:
            print(f"‚ùå Command processing error: {e}")
            self.speak("I apologize, Sir. I encountered an error processing your request.")
            return True
    
    def run_voice_loop(self):
        """Main voice interaction loop"""
        print("\nüî• JARVIS Voice Interface Active!")
        print("=" * 50)
        print("üí¨ Say 'Hey JARVIS' or 'JARVIS' to activate")
        print("üí¨ Say 'stop' or 'exit' to quit")
        print("üí¨ Press Ctrl+C to force exit")
        
        # Initial greeting
        self.speak("JARVIS voice interface online. Ready for your commands, Sir.")
        
        try:
            while True:
                # Listen for wake word
                wake_detected = self.listen_for_wake_word(timeout=30)
                
                if wake_detected:
                    # Acknowledge wake word
                    self.speak("Yes, Sir?")
                    
                    # Listen for command
                    command = self.listen_for_command(timeout=15)
                    
                    if command:
                        # Process command
                        continue_listening = self.process_command(command)
                        
                        if not continue_listening:
                            break
                    else:
                        self.speak("I didn't catch that, Sir. Please try again.")
                
        except KeyboardInterrupt:
            print("\nüõë Interrupt received")
            self.speak("Voice interface shutting down. Goodbye, Sir.")
        except Exception as e:
            print(f"‚ùå Voice loop error: {e}")
            self.speak("Voice system error. Shutting down.")
    
    def test_voice_components(self):
        """Test all voice components"""
        print("\nüß™ Testing JARVIS Voice Components...")
        
        # Test AI
        print("\nüß† Testing AI Engine...")
        try:
            response = self.ai.chat("Hello JARVIS, are you ready?")
            print(f"‚úÖ AI Response: {response}")
        except Exception as e:
            print(f"‚ùå AI Error: {e}")
            return False
        
        # Test TTS
        print("\nüó£Ô∏è Testing Text-to-Speech...")
        try:
            self.speak("Voice test successful. JARVIS speaking clearly.")
            print("‚úÖ TTS Working")
        except Exception as e:
            print(f"‚ùå TTS Error: {e}")
            return False
        
        # Test microphone
        print("\nüé§ Testing Microphone...")
        if self.microphone:
            print("‚úÖ Microphone Ready")
        else:
            print("‚ùå Microphone Not Available")
            return False
        
        # Test speech recognition
        print("\nüé§ Testing Speech Recognition (say something)...")
        try:
            test_command = self.listen_for_command(timeout=5)
            if test_command:
                print(f"‚úÖ Speech Recognition: Heard '{test_command}'")
            else:
                print("‚ö†Ô∏è Speech Recognition: No input detected")
        except Exception as e:
            print(f"‚ùå Speech Recognition Error: {e}")
        
        print("\n‚úÖ Voice component testing complete!")
        return True

def main():
    """Main function"""
    print("üî•üî•üî• JARVIS LOCAL VOICE SYSTEM üî•üî•üî•")
    
    if not HAS_VOICE:
        print("‚ùå Voice dependencies not available")
        print("Please install: pip install speechrecognition pyttsx3 pyaudio")
        return
    
    # Initialize voice engine
    voice_engine = JarvisLocalVoiceEngine()
    
    # Test components first
    print("\nüîß Running system checks...")
    if not voice_engine.test_voice_components():
        print("‚ùå Voice system not ready")
        return
    
    # Ask user what to do
    print("\nüéÆ Choose an option:")
    print("1. Start voice interaction loop")
    print("2. Test individual components")
    print("3. Quick voice test")
    
    try:
        choice = input("\nEnter choice (1-3): ").strip()
        
        if choice == "1":
            voice_engine.run_voice_loop()
        elif choice == "2":
            voice_engine.test_voice_components()
        elif choice == "3":
            print("\nüé§ Quick Test - Say something:")
            command = voice_engine.listen_for_command(timeout=10)
            if command:
                voice_engine.process_command(command)
            else:
                print("‚ùì No input detected")
        else:
            print("Invalid choice")
            
    except KeyboardInterrupt:
        print("\nüëã Exiting...")
    except Exception as e:
        print(f"‚ùå Error: {e}")

if __name__ == "__main__":
    main()
